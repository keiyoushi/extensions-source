name: CI Keiyoushi Style (Flat)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_publish:
    name: Build & Publish (Flat)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate signing key
        run: |
          keytool -genkeypair -alias waltzy -keyalg RSA -keysize 2048 -validity 10000 -keystore signingkey.jks -storepass waltzysign -keypass waltzysign -dname "CN=waltzy"

      - name: Get signing key fingerprint
        run: |
          FINGERPRINT=$(keytool -list -v -keystore signingkey.jks -storepass waltzysign | grep "SHA256: " | head -n 1 | awk '{print $2}' | sed 's/://g' | tr '[:upper:]' '[:lower:]')
          echo "REPO_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV

      - name: Build All Extensions
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease
        env:
          KEY_STORE_PASSWORD: waltzysign
          ALIAS: waltzy
          KEY_PASSWORD: waltzysign

      # BAGIAN INI YANG DIUBAH BIAR MIRIP KEIYOUSHI
      - name: Organize APKs (Flat Structure)
        run: |
          mkdir -p repo
          # Copy APK langsung ke folder repo (bukan repo/apk)
          find . -name "*-release.apk" -exec cp {} repo/ \;

          # Rename file (hapus -release)
          cd repo
          for file in *-release.apk; do
            mv "$file" "${file/-release.apk/.apk}"
          done

          # Hapus file yg bukan APK biar bersih
          rm -f index.html || true

          # Generate repo.json (Required for Mihon/Tachiyomi to accept the repo)
          echo '{
            "meta": {
              "name": "Manga Indo Extensions",
              "website": "https://github.com/'"${{ github.repository }}"'",
              "signingKeyFingerprint": "'"${{ env.REPO_FINGERPRINT }}"'"
            }
          }' > repo.json

      - name: Generate Repo Index (Inspector)
        run: |
          curl -L "https://github.com/keiyoushi/extensions-inspector/releases/latest/download/Inspector.jar" -o Inspector.jar

          # Scan folder "repo" langsung (karena APK udah disitu)
          java -jar Inspector.jar "repo" "repo/index.min.json" "repo/index.json"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update repo (Keiyoushi Flat Style)'
