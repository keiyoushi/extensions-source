name: Ultimate Debug & Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  debug_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      # 1. BIKIN KUNCI DARURAT
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore ${{ github.workspace }}/signingkey.jks -storepass 123456 -alias key0 -keypass 123456 -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Waltzy,O=Waltzy,C=ID"
          echo "✅ Keystore ada di: ${{ github.workspace }}/signingkey.jks"

      # 2. INJEKSI PASSWORD (SEMUA KEMUNGKINAN DIMASUKKAN)
      # Kita tembak semua variabel yang mungkin dipake sama script Gradle
      - name: Inject All Possible Properties
        run: |
          echo "Menulis gradle.properties..."
          
          # Variasi 1: Standard Android Plugin
          echo "android.injected.signing.store.file=${{ github.workspace }}/signingkey.jks" >> gradle.properties
          echo "android.injected.signing.store.password=123456" >> gradle.properties
          echo "android.injected.signing.key.alias=key0" >> gradle.properties
          echo "android.injected.signing.key.password=123456" >> gradle.properties
          
          # Variasi 2: Standard Gradle/Kotlin
          echo "keyStore=${{ github.workspace }}/signingkey.jks" >> gradle.properties
          echo "keyStorePassword=123456" >> gradle.properties
          echo "keyAlias=key0" >> gradle.properties
          echo "keyPassword=123456" >> gradle.properties
          
          # Variasi 3: Keiyoushi Style / Extension Common
          echo "signing.keyStore=${{ github.workspace }}/signingkey.jks" >> gradle.properties
          echo "signing.keyStorePassword=123456" >> gradle.properties
          echo "signing.keyAlias=key0" >> gradle.properties
          echo "signing.keyPassword=123456" >> gradle.properties
          
          # Variasi 4: Polos (Just in case)
          echo "storeFile=${{ github.workspace }}/signingkey.jks" >> gradle.properties
          echo "storePassword=123456" >> gradle.properties
          echo "keyAlias=key0" >> gradle.properties
          echo "keyPassword=123456" >> gradle.properties

          echo "✅ gradle.properties berhasil dibuat penuh!"

      # 3. INTIP ISI build.gradle (Cuma buat jaga-jaga kalau kita perlu debug manual nanti)
      - name: Inspect Build Scripts (Reconnaissance)
        run: |
          echo "=== ISI ROOT BUILD.GRADLE ==="
          cat build.gradle.kts || cat build.gradle || echo "Gak nemu root build.gradle"
          echo "============================="

      # 4. BUILD DENGAN FULL STACKTRACE
      - name: Build All Extensions
        env:
          # Backup: Masukin juga lewat Environment Variable
          INJECT_ESIGN_SIGNING_KEY_STORE_PASSWORD: '123456'
          INJECT_ESIGN_SIGNING_KEY_ALIAS: 'key0'
          INJECT_ESIGN_SIGNING_KEY_PASSWORD: '123456'
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --info

      # 5. GENERATOR PYTHON (Script Final yang sudah terbukti benar)
      - name: Generate Repo Structure
        if: success() # Cuma jalan kalau build di atas IJO
        run: |
          mkdir -p repo
          find . -name "*-release.apk" -exec cp {} repo/ \;
          cd repo
          for file in *-release.apk; do mv "$file" "${file/-release.apk/.apk}"; done

          python3 -c '
          import os, json
          repo_data = []
          base_url = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          
          for filename in os.listdir("."):
              if filename.endswith(".apk"):
                  try:
                      parts = filename.replace(".apk", "").split("-")
                      version = parts[-1].replace("v", "")
                      full_pkg = parts[-2]
                      lang = full_pkg.split(".")[0] if "." in full_pkg else "all"
                      name = full_pkg.split(".")[-1].title()
                      entry = {
                          "name": f"Tachiyomi: {name}",
                          "pkg": f"eu.kanade.tachiyomi.extension.{full_pkg}",
                          "apk": filename,
                          "lang": lang,
                          "code": 1,
                          "version": version,
                          "nsfw": 0,
                          "sources": []
                      }
                      repo_data.append(entry)
                  except: pass

          with open("index.min.json", "w") as f: json.dump(repo_data, f, separators=(",", ":"))
          with open("repo.json", "w") as f: json.dump({"name":"Waltzy","id":"waltzy-repo","baseUrl":base_url,"formatVersion":1}, f, indent=2)
          '

      - name: Deploy to gh-pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update repo (Debug Kitchen Sink)'

 
