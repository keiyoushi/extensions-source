name: CI Keiyoushi Style (Python Native + Fix Key)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_publish:
    name: Build & Publish (With Signing Key)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # PENTING: Biar Spotless gak error history

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      # --- INI YANG DITAMBAHKAN (MEMBUAT KUNCI DARURAT) ---
      - name: Create Dummy Signing Key
        run: |
          # Bikin file signingkey.jks palsu biar build gak error
          keytool -genkey -v -keystore signingkey.jks -storepass 123456 -alias key0 -keypass 123456 -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Waltzy,O=Waltzy,C=ID"

      - name: Build All Extensions
        env:
          # Masukkan password kunci palsu tadi ke Gradle
          INJECT_ESIGN_SIGNING_KEY_STORE_PASSWORD: '123456'
          INJECT_ESIGN_SIGNING_KEY_ALIAS: 'key0'
          INJECT_ESIGN_SIGNING_KEY_PASSWORD: '123456'
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      # SCRIPT PYTHON (TIDAK PERLU DIUBAH, SUDAH BENAR)
      - name: Generate Repo Structure
        run: |
          mkdir -p repo
          
          # Pindahkan APK
          find . -name "*-release.apk" -exec cp {} repo/ \;
          
          cd repo
          
          # Rename APK
          for file in *-release.apk; do
            mv "$file" "${file/-release.apk/.apk}"
          done

          # Python Generator
          python3 -c '
          import os
          import json
          
          repo_data = []
          base_url = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          
          print("Scanning APKs...")
          
          for filename in os.listdir("."):
              if filename.endswith(".apk"):
                  try:
                      parts = filename.replace(".apk", "").split("-")
                      version = parts[-1].replace("v", "")
                      full_pkg_suffix = parts[-2]
                      
                      lang = "all"
                      if "." in full_pkg_suffix:
                          lang = full_pkg_suffix.split(".")[0]
                      
                      name = full_pkg_suffix.split(".")[-1].title()
                      pkg_name = f"eu.kanade.tachiyomi.extension.{full_pkg_suffix}"
                      
                      entry = {
                          "name": f"Tachiyomi: {name}",
                          "pkg": pkg_name,
                          "apk": filename, 
                          "lang": lang,
                          "code": 1, 
                          "version": version,
                          "nsfw": 0,
                          "sources": []
                      }
                      repo_data.append(entry)
                      print(f"Added: {name}")
                  except Exception as e:
                      print(f"Skipping {filename}: {e}")

          with open("index.min.json", "w") as f:
              json.dump(repo_data, f, separators=(",", ":"))
              
          repo_meta = {
              "name": "Waltzy Extensions",
              "id": "waltzy-repo",
              "baseUrl": base_url,
              "formatVersion": 1
          }
          with open("repo.json", "w") as f:
              json.dump(repo_meta, f, indent=2)
          '

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update repo (With Signing  Key Fix)'

