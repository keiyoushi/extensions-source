name: CI Keiyoushi Style (Python Native)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_publish:
    name: Build & Publish (No External Tools)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build All Extensions
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      # INI PENGGANTI INSPECTOR (Script Python Manual)
      # Tidak perlu download JAR, jadi tidak akan error 404 lagi.
      - name: Generate Repo Structure
        run: |
          # 1. Buat folder repo
          mkdir -p repo
          
          # 2. Cari semua APK, pindahkan ke folder repo (FLAT STRUCTURE)
          find . -name "*-release.apk" -exec cp {} repo/ \;
          
          # 3. Masuk ke folder repo
          cd repo
          
          # 4. Bersihkan nama file (hapus -release)
          for file in *-release.apk; do
            mv "$file" "${file/-release.apk/.apk}"
          done

          # 5. Jalankan Python untuk bikin JSON
          python3 -c '
          import os
          import json
          
          repo_data = []
          # Ganti URL ini otomatis nanti sama GitHub Pages lu
          base_url = "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          
          print("Scanning APKs...")
          
          for filename in os.listdir("."):
              if filename.endswith(".apk"):
                  try:
                      # CONTOH NAMA: tachiyomi-id.komikcast-v1.2.3.apk
                      # Kita pecah namanya buat ambil data
                      parts = filename.replace(".apk", "").split("-")
                      
                      # Ambil Versi (v1.2.3 -> 1.2.3)
                      version = parts[-1].replace("v", "")
                      
                      # Ambil Package & Lang
                      # parts[-2] biasanya "id.komikcast"
                      full_pkg_suffix = parts[-2]
                      
                      lang = "all"
                      if "." in full_pkg_suffix:
                          lang = full_pkg_suffix.split(".")[0] # Ambil "id"
                      
                      # Ambil Nama (Komikcast)
                      name = full_pkg_suffix.split(".")[-1].title() 
                      
                      # Bikin Package Name Lengkap
                      pkg_name = f"eu.kanade.tachiyomi.extension.{full_pkg_suffix}"
                      
                      # Masukkan ke data JSON (FORMAT FLAT KEIYOUSHI)
                      entry = {
                          "name": f"Tachiyomi: {name}",
                          "pkg": pkg_name,
                          "apk": filename, 
                          "lang": lang,
                          "code": 1, 
                          "version": version,
                          "nsfw": 0,
                          "sources": []
                      }
                      repo_data.append(entry)
                      print(f"Added: {name}")
                  except Exception as e:
                      print(f"Skipping {filename}: {e}")

          # Simpan index.min.json
          with open("index.min.json", "w") as f:
              json.dump(repo_data, f, separators=(",", ":"))
              
          # Simpan repo.json (PENTING BUAT MIHON)
          repo_meta = {
              "name": "Waltzy Extensions",
              "id": "waltzy-repo",
              "baseUrl": base_url,
              "formatVersion": 1
          }
          with open("repo.json", "w") as f:
              json.dump(repo_meta, f, indent=2)
          '

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update repo (Python Native)'
