name: Build extensions

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      STORE_PASSWORD: android
      KEY_PASSWORD: android
      KEY_ALIAS: key
      STORE_FILE: signingkey.jks
      ALIAS: key
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Generate signing key
        run: |
          keytool -genkeypair \
            -alias key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore ${{ github.workspace }}/signingkey.jks \
            -storepass android \
            -keypass android \
            -dname "CN=waltzy, OU=waltzy, O=waltzy, L=Unknown, ST=Unknown, C=US"

      - name: Create local.properties
        run: |
          echo "STORE_FILE=${{ github.workspace }}/signingkey.jks" >> local.properties
          echo "STORE_PASSWORD=android" >> local.properties
          echo "KEY_ALIAS=key" >> local.properties
          echo "KEY_PASSWORD=android" >> local.properties

      - name: Create gradle.properties signing
        run: |
          echo "RELEASE_STORE_FILE=${{ github.workspace }}/signingkey.jks" >> gradle.properties
          echo "RELEASE_STORE_PASSWORD=android" >> gradle.properties
          echo "RELEASE_KEY_ALIAS=key" >> gradle.properties
          echo "RELEASE_KEY_PASSWORD=android" >> gradle.properties

      - name: Build extensions
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease -x spotlessCheck -x spotlessGradleCheck --no-build-cache \
            -Pandroid.injected.signing.store.file=${{ github.workspace }}/signingkey.jks \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=key \
            -Pandroid.injected.signing.key.password=android

      - name: Generate repo
        run: python3 .github/scripts/generate-repo.py

      - name: Deploy repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: repo
          publish_dir:  ./output
